#coding=utf-8
import bottle
from bottle import get, post, request, route, install, template
import sqlite3
import time

@route('/listener', method='POST')
def listener():
	specific_para = ""
	content_length = ""

	detect_type = request.POST.get('detect_type')
	specific_para = request.POST.get('specific_para')
	requests = request.POST.get('request')
	host = request.POST.get('host')
	content_length = request.POST.get('content_length')
	para_str = request.POST.get('para_str')
	print host
	from vuln_detect import fuzzer
	try:
		fuzzer = fuzzer(requests, detect_type, para_str, host ,specific_para, content_length)
		log_value = fuzzer.detect()
	except Exception, e:
		print e


@route('/index')
def vulns():
	pentest_date = time.strftime('%Y-%m-%d',time.localtime(time.time()))
	conn = sqlite3.connect('pentest_request_fuzzer.db')
	db = conn.cursor()
	db.execute('select * from vulns where pentest_date="%s"'%(pentest_date))
	row = db.fetchall()
	db.close()
	row_name = ["主机名","请求包","漏洞类型","漏洞位置","检测日期"]
	if row:
		output = bottle.template('make_table', rows = row, title="扫描检测结果",row_names = row_name )
		return output


@route('/waf')
def vulns():
	conn = sqlite3.connect('pentest_request_fuzzer.db')
	db = conn.cursor()
	db.execute('select * from wafs where pentest_date="%s"'%(pentest_date))
	row = db.fetchall()
	db.close()
	row_name = ["主机名","WAF类型","检测日期"]
	if row:
		output = bottle.template('make_table', rows = row, title = "WAF检测结果", row_names = row_name)
		return output


bottle.run(host='localhost', port=8083)
